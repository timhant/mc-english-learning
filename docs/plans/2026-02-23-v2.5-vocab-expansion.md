# v2.5 词库扩充设计文档
*日期：2026-02-23*
*状态：已确认*

## 概述
将词库从 156 词扩充至 434 词，同时改造分级机制为"游戏进程分级 + 超纲可触发"。
新增物品（Items）触发类型，新增播放锁防止音频重叠。

完整词表：`v2.5-word-list.json`

## 核心改动

### 1. 分级机制改造

**当前等级词汇**触发完整体验：
- 大标题显示（Title）
- 英文 + 中文语音朗读
- 音标显示
- 首次发现"新词解锁!"庆祝（粒子 + 音效 + XP）
- 计入进度，影响升级

**超纲词汇（未解锁等级）**触发轻量体验：
- ActionBar 小字显示（英文 + 中文）
- 英文 + 中文语音朗读（保留）
- 无庆祝特效、无 XP
- 不计入进度
- 冷却时间加倍（120 秒 vs 60 秒）

### 2. 物品触发机制（新增）

**触发方式**：玩家切换手持物品时触发（selected slot change）
- 监听 `player` 的 inventory selected slot 变化
- 读取当前手持物品的 typeId
- 在 `itemMap` 中查找对应词条
- 触发完整/轻量体验（同实体/方块的等级判定逻辑）

**实现**：新增 `itemLearn.js` 模块
```js
// 每秒检查一次玩家手持物品变化
system.runInterval(() => {
  for (const player of world.getAllPlayers()) {
    const inventory = player.getComponent("minecraft:inventory");
    const slot = inventory.container.getSlot(player.selectedSlotIndex);
    const itemId = slot?.typeId;
    // 对比上次记录，变化时触发学习
  }
}, 20);
```

### 3. 播放锁机制（新增）

**问题**：玩家可能同时靠近生物 + 切换物品，导致两个词条音频重叠播放。

**方案**：全局播放锁（Playback Lock）
```js
// voice.js 新增
let isPlaying = false;
let playLockTimeout = null;
const PLAY_LOCK_DURATION = 80; // 4秒 = 80 ticks

export function playWordAudio(player, minecraftId) {
  if (isPlaying) return false; // 锁定中，丢弃
  isPlaying = true;

  // 播放英文 + 中文音频...

  // 设置解锁定时器
  if (playLockTimeout) system.clearRun(playLockTimeout);
  playLockTimeout = system.runTimeout(() => {
    isPlaying = false;
  }, PLAY_LOCK_DURATION);

  return true;
}
```

**设计决策**：
- **丢弃而非排队**：排队会导致走过一群动物后连续播放，体验更差
- **锁定时长 4 秒**：英文单词(~1s) + 间隔(1.5s) + 中文(~1s) + 余量(0.5s)
- **返回 boolean**：调用方可据此决定是否显示视觉提示（锁定时也不显示 Title）
- **全局锁而非每玩家锁**：Script API 的 playsound 是服务端指令，同一玩家不应同时播两个词

### 4. 新分级体系（按游戏进程）

#### ⭐ Lv1 — 第一天 First Day（~100 词）
孩子出生后第一天就能遇到的一切。

**实体（~20）**：
| Key | English | 中文 | minecraft:id |
|-----|---------|------|-------------|
| cow | Cow | 奶牛 | cow |
| pig | Pig | 猪 | pig |
| sheep | Sheep | 绵羊 | sheep |
| chicken | Chicken | 鸡 | chicken |
| horse | Horse | 马 | horse |
| donkey | Donkey | 驴 | donkey |
| cat | Cat | 猫 | cat |
| wolf | Wolf | 狼 | wolf |
| rabbit | Rabbit | 兔子 | rabbit |
| bee | Bee | 蜜蜂 | bee |
| zombie | Zombie | 僵尸 | zombie |
| skeleton | Skeleton | 骷髅 | skeleton |
| spider | Spider | 蜘蛛 | spider |
| creeper | Creeper | 苦力怕 | creeper |
| enderman | Enderman | 末影人 | enderman |
| phantom | Phantom | 幻翼 | phantom |
| drowned | Drowned | 溺尸 | drowned |
| squid | Squid | 鱿鱼 | squid |
| bat | Bat | 蝙蝠 | bat |
| fish | Fish | 鱼 | cod |

**方块（~80）**：
地表方块：dirt, grass, stone, cobblestone, sand, gravel, clay, farmland, path, mud, moss, podzol, mycelium, soul_sand
木材全家族：oak_log, oak_planks, birch_log, birch_planks, spruce_log, spruce_planks, jungle_log, jungle_planks, acacia_log, acacia_planks, dark_oak_log, dark_oak_planks, mangrove_log, cherry_log, bamboo_block
基础建材：cobblestone, stone_brick, brick, sandstone, glass, concrete, terracotta, wool
植物：flower, sunflower, mushroom, sugar_cane, cactus, bamboo, vine, lily_pad, fern, seagrass, kelp, wheat, carrot, potato, beetroot, pumpkin, melon, sweet_berry
基础家具/工具方块：crafting_table, furnace, chest, torch, bed, door, ladder, fence, gate, slab, stairs, trapdoor, button, lever, sign, campfire, barrel, composter, bookshelf, painting, flower_pot, carpet
浅层矿石：coal_ore, iron_ore, copper_ore
自然：water, lava, ice, snow, leaves

#### ⭐⭐ Lv2 — 第一周 First Week（~100 词）
开始建房、挖矿、养殖后接触的内容。

**实体（~15）**：
villager, iron_golem, fox, ocelot, parrot, turtle, dolphin, panda, goat, salmon, tropical_fish, witch, slime, husk, stray

**方块（~85）**：
更多矿石：gold_ore, diamond_ore, redstone_ore, lapis_ore, emerald_ore, deepslate, amethyst
金属块：iron_block, gold_block, copper_block
工作站：anvil, stonecutter, smithing_table, blast_furnace, smoker, brewing_stand, enchanting_table, cauldron, grindstone, loom, cartography_table, fletching_table, lectern
红石基础：redstone_block, repeater, comparator, piston, sticky_piston, observer, hopper, dropper, dispenser, daylight_sensor, target, bell, tripwire_hook, pressure_plate, tnt
自然方块：hay, melon_block, pumpkin, honeycomb_block, coral, dripstone, pointed_dripstone, calcite, tuff, copper_block, raw_iron_block, raw_gold_block, raw_copper_block
建筑进阶：mossy_cobblestone, mossy_stone_brick, cracked_stone_brick, chiseled_stone_brick, prismarine, dark_prismarine, sea_lantern, lantern, soul_lantern, chain, lightning_rod, candle
容器/存储：ender_chest, shulker_box, lodestone, armor_stand
装饰：banner, glazed_terracotta, stained_glass

#### ⭐⭐⭐ Lv3 — 探索期 Exploration（~100 词）
探索更多生态群系、村庄、遗迹。

**实体（~20）**：
polar_bear, llama, trader (wandering_trader), frog, camel, sniffer, armadillo, axolotl, glow_squid, cave_spider, silverfish, pillager, ravager, evoker, vex, vindicator, witch, guardian, elder_guardian, wither_skeleton

**方块（~80）**：
深层矿石：deepslate_iron_ore, deepslate_gold_ore, deepslate_diamond_ore, deepslate_coal_ore, deepslate_copper_ore, deepslate_redstone_ore, deepslate_lapis_ore, deepslate_emerald_ore
进阶建材：quartz, purpur_block, end_stone, end_brick, obsidian, crying_obsidian, blackstone, basalt, polished_basalt, smooth_basalt, polished_blackstone, gilded_blackstone, polished_deepslate, reinforced_deepslate
自然奇观：sculk, sculk_sensor, sculk_shrieker, sculk_catalyst, budding_amethyst, dripstone_block, moss_block, azalea, flowering_azalea, spore_blossom, glow_lichen, hanging_roots, dripleaf
下界入门：netherrack, nether_brick, magma_block, soul_soil, warped_stem, crimson_stem, warped_planks, crimson_planks, shroomlight, warped_wart_block, nether_wart_block, nether_gold_ore, ancient_debris
遗迹方块：spawner, cobweb, bone_block, chiseled_bookshelf, suspicious_sand, suspicious_gravel, decorated_pot, brush, trial_spawner, vault
红石进阶：note_block, jukebox, command_block, structure_block, barrier

#### ⭐⭐⭐⭐ Lv4 — 下界征途 Nether Journey（~100 词）
下界探索、酿造、附魔。

**实体（~15）**：
blaze, ghast, magma_cube, piglin, hoglin, strider, zombified_piglin, piglin_brute, wither, snow_golem, allay, warden, endermite, phantom, breeze

**方块（~85）**：
下界高级：glowstone, nether_wart, soul_campfire, respawn_anchor, lodestone, nether_sprouts, twisting_vines, weeping_vines, crimson_fungus, warped_fungus, crimson_roots, warped_roots, blackstone_brick, polished_blackstone_brick, cracked_polished_blackstone_brick, chiseled_polished_blackstone, quartz_brick, basalt_pillar
药水相关：brewing_stand, cauldron, dragon_breath (entity concept)
附魔相关：enchanting_table, experience (concept), lapis_lazuli (item concept)
更多建筑：copper_bulb, copper_door, copper_trapdoor, copper_grate, waxed_copper, oxidized_copper, cut_copper, tinted_glass, frosted_ice
特殊方块：beacon, conduit, end_portal_frame, end_gateway, end_rod, chorus_plant, chorus_flower, shulker_box, dragon_egg
更多红石：sculk_sensor, calibrated_sculk_sensor, crafter

#### ⭐⭐⭐⭐⭐ Lv5 — 终末之地 The End（~100 词）
末地、最终 Boss、收集向内容。

**实体（~10）**：
ender_dragon, shulker, endermite, elder_guardian, warden, sniffer, iron_golem (already in Lv2), snow_golem, bee (已在 Lv1)
（注：Lv5 实体较少，主要是稀有/终局生物）

**方块/概念（~90）**：
末地方块：end_stone, end_brick, purpur_block, purpur_pillar, end_rod, dragon_egg, end_portal_frame, chorus_plant, chorus_flower
进阶红石完整：command_block, repeating_command_block, chain_command_block, structure_block, structure_void, jigsaw, light_block
稀有/收集向：sponge, wet_sponge, ancient_debris, netherite_block, diamond_block, emerald_block, amethyst_block, budding_amethyst, calibrated_sculk_sensor, heavy_core
所有剩余有教育价值的方块...

## 3. 代码改动清单

### 3.1 新文件结构
```
vocab/
  index.js          # 汇总 + 按等级构建 entityMap/blockMap/itemMap
  level1.js ~ level5.js  # 重写，按游戏进程分级，含 entities/blocks/items 三类
scripts/
  itemLearn.js      # 新增：物品切换触发学习
  voice.js          # 改造：新增播放锁
```

### 3.2 proximity.js 改动
- 检测到实体时，判断是否在当前等级
- 当前等级 → 调用 fullExperience()
- 超纲 → 调用 lightExperience()

### 3.3 blockLearn.js 改动
- 同上逻辑

### 3.4 新增 lightExperience 函数
- ActionBar 显示：`§7{EN} §8| §7{CN}`（灰色，低调）
- 语音照常播放
- 无 Title、无粒子、无 XP
- 冷却 120 秒

### 3.5 progress.js 改动
- 只追踪当前等级的词
- 超纲词不计入升级进度
- 但可以记录"已预览"状态（为"重逢惊喜"做准备）

### 3.6 itemLearn.js（新增）
- 每秒检查玩家手持物品变化
- 记录每个玩家上次手持物品 ID
- 变化时查 `itemMap`，判断等级，触发对应体验
- 冷却机制同 blockLearn.js

### 3.7 voice.js
- 新增全局播放锁（`isPlaying` + 4秒定时器）
- `playWordAudio()` 返回 boolean，锁定中返回 false
- 调用方据返回值决定是否显示视觉效果

### 3.8 sound_definitions.json + 音频文件
- 新增约 278 个词 × 2 = 556 个新 ogg 文件
- 使用 Edge TTS 生成（mc-tts-audio skill）

### 3.9 config.json
- 新增 `outOfLevelCooldown: 120`
- 新增 `outOfLevelEnabled: true`（可关闭超纲触发）
- 新增 `playLockDuration: 80`（播放锁时长，ticks）

## 4. 实施步骤

### Step 1: 词库定稿
- 确认完整 500 词列表（key, en, cn, phonetic, minecraft_id, level）
- 输出为 JSON 供开发使用

### Step 2: 代码改造
- 重写 level1-5.js
- 改造 proximity.js / blockLearn.js 支持双模式触发
- 新增 lightExperience 逻辑
- 更新 progress.js

### Step 3: 音频生成
- 用 mc-tts-audio skill 批量生成新增词的音频
- 更新 sound_definitions.json

### Step 4: 测试 & 部署
- 部署到 Alienware 测试服务器
- Tim 实测验证
- 提交 GitHub

## 5. voice.js 中 specialMap 更新
新增的所有词需要在 voice.js 的 SPECIAL_MAP 中添加 minecraft_id → audio_key 映射（对于 id 和 key 不一致的情况）。
